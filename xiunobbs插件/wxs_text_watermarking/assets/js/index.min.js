(function(){const WATERMARK_FLAG='[文本盲水印:';const PROCESSED_FLAG='data-watermark-processed';if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initWatermarking)}else{initWatermarking()}function initWatermarking(){if(typeof window.wxstbwConfig==='undefined'){console.warn('文本盲水印：配置未找到，插件可能未启用');return}const config=window.wxstbwConfig;const isDebug=!!config.debug_mode;const isEnabled=!!config.enable;if(isEnabled&&isBotUserAgent(config,isDebug)){isDebug&&console.log('文本盲水印：检测到爬虫UA，跳过水印处理');return}if(!isEnabled){isDebug&&console.log('文本盲水印：插件未启用');return}const messageElements=document.querySelectorAll('div.message[isfirst="1"]');if(messageElements.length===0){if(isDebug)console.log('文本盲水印：未找到isfirst="1"的.message元素');return}isDebug&&console.log(`文本盲水印：找到${messageElements.length}个.message元素`);messageElements.forEach((messageElement,index)=>{processMessageElement(messageElement,config,isDebug,index)});isDebug&&console.log('文本盲水印：所有.message元素处理完成')}function processMessageElement(messageElement,config,isDebug,index){try{const originalHTML=messageElement.innerHTML;const wrapper=document.createElement('div');wrapper.className='wxs-text-watermark-wrap';wrapper.setAttribute('data-watermark-target','true');wrapper.setAttribute('data-index',index);wrapper.innerHTML=originalHTML;messageElement.innerHTML='';messageElement.appendChild(wrapper);wrapper.style.display='block';wrapper.style.visibility='visible';wrapper.style.opacity='1';isDebug&&console.log(`文本盲水印：开始处理第${index+1}个.message元素`);processWatermarks(config,wrapper,isDebug);isDebug&&console.log(`文本盲水印：第${index+1}个.message元素处理完成`)}catch(error){console.error(`文本盲水印处理第${index+1}个.message元素失败：`,error)}}function isBotUserAgent(config,isDebug){if(!Array.isArray(config.bot_ua)||config.bot_ua.length===0){isDebug&&console.log('文本盲水印：爬虫UA配置为空，跳过检测');return false}const userAgent=(navigator.userAgent||'').toLowerCase().replace(/\s+/g,' ').trim();isDebug&&console.log('文本盲水印：当前用户UA（格式化后）：',userAgent);const botUAs=config.bot_ua.map(bot=>(bot||'').toLowerCase().trim()).filter(bot=>bot.length>0);const isBot=botUAs.some(bot=>{const isMatch=userAgent.includes(bot);if(isMatch&&isDebug){console.log(`文本盲水印：匹配到爬虫UA标识：${bot}`)}return isMatch});return isBot}async function processWatermarks(config,targetElement,isDebug){try{const watermark=await generateWatermark(config,isDebug);if(!watermark){isDebug&&console.log('文本盲水印：水印内容为空');return}processTargetTags(config,watermark,targetElement,isDebug)}catch(error){console.error('文本盲水印处理失败：',error)}}function processTargetTags(config,watermark,targetElement,isDebug){const tags=Array.isArray(config.html_tags)?config.html_tags:['p','li'];tags.forEach(tag=>{if(!tag||typeof tag!=='string')return;const elements=targetElement.getElementsByTagName(tag);const elementCount=elements.length;isDebug&&console.log(`文本盲水印：在目标元素中找到${elementCount}个<${tag}>标签`);Array.from(elements).forEach(element=>{if(element.closest('pre, code, .code-toolbar, a'))return;processTextNodesInElement(element,config,watermark,isDebug)})})}function processTextNodesInElement(element,config,watermark,isDebug){const walker=document.createTreeWalker(element,NodeFilter.SHOW_TEXT,{acceptNode:function(node){if(node[PROCESSED_FLAG])return NodeFilter.FILTER_REJECT;const text=node.nodeValue?.trim()||'';if(!text||node.parentElement.closest('pre, code, .code-toolbar, a')){return NodeFilter.FILTER_REJECT}if(text.includes(WATERMARK_FLAG))return NodeFilter.FILTER_REJECT;return NodeFilter.FILTER_ACCEPT}});const textNodes=[];let node;while(node=walker.nextNode()){textNodes.push(node)}textNodes.forEach(textNode=>{const originalText=textNode.nodeValue||'';const textLength=originalText.replace(/\s+/g,'').length;if(textLength<config.min_paragraph_length){return}textNode[PROCESSED_FLAG]=true;const processedText=processTextWithWatermark(originalText,watermark,config);if(processedText!==originalText){textNode.nodeValue=processedText;isDebug&&console.log('文本盲水印：已处理文本节点',{原长度:originalText.length,新长度:processedText.length,预览:originalText.substring(0,50)+'...'})}})}function isUrl(text){const urlRegex=/^(https?:\/\/|ftp:\/\/|www\.)[^\s]+$/i;return urlRegex.test(text)}function isContainUrl(text){const urlRegex=/(https?:\/\/|ftp:\/\/|www\.)[^\s]+/i;return urlRegex.test(text)}async function generateWatermark(config,isDebug){const watermarkParts=[];if(config.include_ip){let ip='unknown';try{ip=await wxsTextWatermarkingGetIP();isDebug&&console.log('文本盲水印：获取到IP：',ip)}catch(e){isDebug&&console.warn('文本盲水印：获取IP失败',e)}watermarkParts.push(`IP:${ip}`)}if(config.include_user){const userId=window.wxstbw_isUserLoggedIn?window.wxstbw_current_user_id:'guest';watermarkParts.push(`USER:${userId}`)}if(config.include_author&&window.wxstbw_author_uid){watermarkParts.push(`AUTHOR:${window.wxstbw_author_uid}`)}if(config.include_thread&&window.wxstbw_thread_id){watermarkParts.push(`THREAD:${window.wxstbw_thread_id}`)}if(config.include_time){const now=new Date();const timeStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;watermarkParts.push(`TIME:${timeStr}`)}if(config.include_custom&&config.custom_text){watermarkParts.push(config.custom_text)}if(watermarkParts.length===0)return'';const watermarkContent=watermarkParts.join('|');return config.debug_mode?`[文本盲水印:${watermarkContent}]`:encodeToVariationSelectors(watermarkContent)}function encodeToVariationSelectors(text){let result='';for(let i=0;i<text.length;i++){const charCode=text.charCodeAt(i);if(charCode<16){result+=String.fromCodePoint(0xFE00+charCode)}else if(charCode<256){result+=String.fromCodePoint(0xE0100+(charCode-16))}else{encodeUTF8(text[i]).forEach(byte=>{result+=byte<16?String.fromCodePoint(0xFE00+byte):String.fromCodePoint(0xE0100+(byte-16))})}}return result}function encodeUTF8(char){const codePoint=char.codePointAt(0);const bytes=[];if(codePoint<=0x7F){bytes.push(codePoint)}else if(codePoint<=0x7FF){bytes.push(0xC0|(codePoint>>6));bytes.push(0x80|(codePoint&0x3F))}else if(codePoint<=0xFFFF){bytes.push(0xE0|(codePoint>>12));bytes.push(0x80|((codePoint>>6)&0x3F));bytes.push(0x80|(codePoint&0x3F))}else{bytes.push(0xF0|(codePoint>>18));bytes.push(0x80|((codePoint>>12)&0x3F));bytes.push(0x80|((codePoint>>6)&0x3F));bytes.push(0x80|(codePoint&0x3F))}return bytes}function processTextWithWatermark(text,watermark,config){if(isUrl(text)){return text}if(text.includes('\n')){return text.split('\n').map(line=>{const lineTrim=line.trim();if(!lineTrim||lineTrim.replace(/\s+/g,'').length<config.min_paragraph_length||lineTrim.includes(WATERMARK_FLAG)){return line}if(isUrl(lineTrim)){return line}return insertWatermarkWithExclusions(line,watermark,config)}).join('\n')}return insertWatermarkWithExclusions(text,watermark,config)}function insertWatermarkWithExclusions(text,watermark,config){if(!text||!watermark)return text;const insertMethod=config.insert_method||1;switch(insertMethod){case 1:return text+watermark;case 2:return insertRandomWatermarkWithExclusions(text,watermark,config);case 3:return insertFixedIntervalWatermarkWithExclusions(text,watermark,config);default:return text}}function insertRandomWatermarkWithExclusions(text,watermark,config){let insertCount=Math.max(1,parseInt(config.random_custom_count)||1);const textLength=text.length;if(textLength<10)insertCount=1;const excludeRanges=getExcludeRanges(text);const insertRanges=getInsertRanges(excludeRanges,textLength);if(insertRanges.length===0){return text}const positions=new Set();let attempts=0;const maxAttempts=insertCount*10;while(positions.size<insertCount&&attempts<maxAttempts){attempts++;const rangeIndex=Math.floor(Math.random()*insertRanges.length);const range=insertRanges[rangeIndex];const minPos=range.start+1;const maxPos=range.end-1;if(maxPos>minPos){const pos=Math.floor(Math.random()*(maxPos-minPos))+minPos;positions.add(pos)}}const sortedPositions=Array.from(positions).sort((a,b)=>a-b);let result='';let lastPos=0;sortedPositions.forEach((pos,index)=>{const offset=index*watermark.length;const actualPos=pos+offset;result+=text.substring(lastPos,pos);result+=watermark;lastPos=pos});result+=text.substring(lastPos);return result}function insertFixedIntervalWatermarkWithExclusions(text,watermark,config){const interval=Math.max(5,parseInt(config.fixed_interval)||20);const textLength=text.length;const excludeRanges=getExcludeRanges(text);let result='';let currentPos=0;let insertIndex=0;while(currentPos<textLength){const isInExcludedRange=excludeRanges.some(range=>currentPos>=range.start&&currentPos<range.end);if(isInExcludedRange){const containingRange=excludeRanges.find(range=>currentPos>=range.start&&currentPos<range.end);if(containingRange){result+=text.substring(currentPos,containingRange.end);currentPos=containingRange.end;continue}}result+=text[currentPos];currentPos++;if((currentPos%interval===0)&&currentPos<textLength&&!isAtExcludedBoundary(currentPos,excludeRanges)){result+=watermark;insertIndex++}}return result}function getExcludeRanges(text){const excludeRanges=[];const urlRegex=/(https?:\/\/[^\s]+|www\.[^\s]+|ftp:\/\/[^\s]+)/gi;let urlMatch;while((urlMatch=urlRegex.exec(text))!==null){excludeRanges.push({type:'url',start:urlMatch.index,end:urlMatch.index+urlMatch[0].length})}const emailRegex=/[\w.%+-]+@[\w.-]+\.[a-zA-Z]{2,}/gi;let emailMatch;while((emailMatch=emailRegex.exec(text))!==null){excludeRanges.push({type:'email',start:emailMatch.index,end:emailMatch.index+emailMatch[0].length})}const filePathRegex=/(\/[^/\s]+)+(\/[^/\s]*)?|([a-zA-Z]:\\(?:[^\\/:*?"<>|\r\n]+\\)*[^\\/:*?"<>|\r\n]*)/gi;let filePathMatch;while((filePathMatch=filePathRegex.exec(text))!==null){excludeRanges.push({type:'filepath',start:filePathMatch.index,end:filePathMatch.index+filePathMatch[0].length})}const codeRegex=/(?:v?\d+\.\d+(?:\.\d+)?|\b[A-Z]{2,10}\d+\b|\b[A-Z]+_\d+\b)/gi;let codeMatch;while((codeMatch=codeRegex.exec(text))!==null){if(codeMatch[0].length>=4){excludeRanges.push({type:'code',start:codeMatch.index,end:codeMatch.index+codeMatch[0].length})}}excludeRanges.sort((a,b)=>a.start-b.start);const mergedRanges=[];for(const range of excludeRanges){if(mergedRanges.length===0){mergedRanges.push({...range})}else{const lastRange=mergedRanges[mergedRanges.length-1];if(range.start<=lastRange.end){lastRange.end=Math.max(lastRange.end,range.end)}else{mergedRanges.push({...range})}}}return mergedRanges}function getInsertRanges(excludeRanges,textLength){const insertRanges=[];if(excludeRanges.length===0){return[{start:0,end:textLength}]}if(excludeRanges[0].start>0){insertRanges.push({start:0,end:excludeRanges[0].start})}for(let i=0;i<excludeRanges.length-1;i++){const currentEnd=excludeRanges[i].end;const nextStart=excludeRanges[i+1].start;if(nextStart-currentEnd>0){insertRanges.push({start:currentEnd,end:nextStart})}}const lastExclude=excludeRanges[excludeRanges.length-1];if(lastExclude.end<textLength){insertRanges.push({start:lastExclude.end,end:textLength})}return insertRanges}function isAtExcludedBoundary(position,excludeRanges){return excludeRanges.some(range=>position===range.start||position===range.end||position===range.start-1||position===range.end+1)}function wxsTextWatermarkingGetIP(){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest();xhr.open('GET','./plugin/wxs_text_watermarking/getip.php',true);xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){try{var response=JSON.parse(xhr.responseText);resolve(response.success?response.ip:'unknown')}catch(e){reject(new Error('IP响应解析失败'))}}else{reject(new Error('IP请求网络失败'))}}};xhr.send()})}})();