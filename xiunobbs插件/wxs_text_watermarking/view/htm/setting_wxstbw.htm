<?php include _include(ADMIN_PATH.'view/htm/header.inc.htm');?>

<div class="row">
	<div class="col-lg-12">
		<div class="btn-group mb-3" role="group">
			<?php echo admin_tab_active($menu['setting']['tab'], 'wxstbw', '文本盲水印设置');?>
		</div>
		<div class="card">
			<div class="card-body"> 
				<form action="<?php echo url('setting-wxstbw');?>" method="post" id="form">
					<!-- 欢迎内容 -->
					<div class="wxstbw-welcome-panel mb-5 pb-3 border-bottom">
						<h3 style="color:#fd4c73;"><i class="fa fa-heart fa-fw"></i> 感谢您使用文本盲水印插件</h3>
						<p>插件功能：该插件可在帖子内容中嵌入不可见的盲水印，帮助您保护原创内容版权。</p>
						<div class="wxstbw-features" style="display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0;">
							<div class="wxstbw-feature-box" style="flex: 1; min-width: 250px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
								<h4>多种插入方式</h4>
								<p>支持段落末尾、随机位置、固定字符间隔三种水印插入方式</p>
							</div>
							<div class="wxstbw-feature-box" style="flex: 1; min-width: 250px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
								<h4>自定义水印内容</h4>
								<p>可包含访客IP、用户ID、时间戳及自定义文本信息</p>
							</div>
							<div class="wxstbw-feature-box" style="flex: 1; min-width: 250px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
								<h4>爬虫过滤功能</h4>
								<p>可设置对搜索引擎爬虫不插入水印，避免影响收录</p>
							</div>
						</div>
						<p>调试模式下水印将以可见文本形式展示，方便测试效果。</p>
						<a href="https://wxsnote.cn/wbmsy" target="_blank" style="display: inline-block; padding: 8px 15px; background: #007bff; color: #fff; border-radius: 4px; text-decoration: none; margin: 5px 0;"><i class="fa fa-paper-plane"></i> 前往提取水印</a>
						<a href="https://github.com/twsh0305/text_watermarking/tree/main/xiunobbs%E6%8F%92%E4%BB%B6/xiunobbs%E6%8F%92%E4%BB%B6%E4%B8%8B%E8%BD%BD" target="_blank" style="display: inline-block; padding: 8px 15px; background: #6c757d; color: #fff; border-radius: 4px; text-decoration: none; margin: 5px 0;"><i class="fa fa-cloud-upload"></i> 检查更新</a>
						<p>插件作者: 天无神话</p>
						<p>作者邮箱: admin@wxsnote.cn</p>
						<p>插件QQ: 2031301686</p>
						<p>作者博客: <a href="https://wxsnote.cn/" target="_blank">王先生的笔记</a></p>
						<p>QQ交流群: <a href="https://jq.qq.com/?_wv=1027&k=eiGEOg3i" target="_blank">399019539</a></p>
						<p>由天无神话开发制作，转载请注明开源地址，感谢配合。</p>
						<p style="color:red">核心开源协议要求：禁止移除或修改作者信息</p>
						<p>原理介绍: <a href="https://wxsnote.cn/6395.html" target="_blank">https://wxsnote.cn/6395.html</a></p>
						<p>开源地址: <a href="https://github.com/twsh0305/text_watermarking" target="_blank">https://github.com/twsh0305/text_watermarking</a></p>
						<p> 加密方案: <a href="https://github.com/paulgb/emoji-encoder" target="_blank">Emoji Encoder</a></p>
					</div>

					<!-- 基础设置内容 -->
					<div class="mb-5 pb-3 border-bottom">
						<h4 class="mb-3"><i class="fa fa-cog fa-fw"></i> 基础设置</h4>
                        
                        <!-- 总开关 -->
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">启用文本盲水印：</label>
                            <div class="col-sm-10">
                                <?php echo $input['enable']; ?>
                                <small class="form-text text-muted">启用或禁用文本盲水印功能</small>
                            </div>
                        </div>
                        
                        <!-- 最小段落长度 -->
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">最小段落长度：</label>
                            <div class="col-sm-10">
                                <div class="input-group" style="max-width: 300px;">
                                    <?php echo $input['min_paragraph_length'];?>
                                    <div class="input-group-append">
                                        <span class="input-group-text">字符</span>
                                    </div>
                                </div>
                                <small class="form-text text-muted">字符数少于该值的段落不插入水印（推荐15-30）</small>
                            </div>
                        </div>
						
						<!-- 插入方式选择 -->
						<div class="form-group row">
							<label class="col-sm-2 form-control-label">水印插入方式：</label>
							<div class="col-sm-10">
								<?php echo $input['insert_method'];?>
								<small class="form-text text-muted">选择水印在帖子中的插入形式</small>
							</div>
						</div>
						
						<!-- 随机位置插入设置 -->
						<div class="form-group row">
							<label class="col-sm-2 form-control-label">随机位置插入-数量模式：</label>
							<div class="col-sm-10">
								<?php echo $input['random_count_type'];?>
								<small class="form-text text-muted">选择水印插入数量的计算方式</small>
							</div>
						</div>
						
						<div class="form-group row">
							<label class="col-sm-2 form-control-label">随机位置-自定义插入数量：</label>
							<div class="col-sm-10">
                                <div class="input-group" style="max-width: 300px;">
                                    <?php echo $input['random_custom_count'];?>
                                    <div class="input-group-append">
                                        <span class="input-group-text">个/段落</span>
                                    </div>
                                </div>
								<small class="form-text text-muted">每个段落固定插入的水印数量</small>
							</div>
						</div>
						
						<div class="form-group row">
							<label class="col-sm-2 form-control-label">随机位置-字数比例：</label>
							<div class="col-sm-10">
                                <div class="input-group" style="max-width: 300px;">
                                    <?php echo $input['random_word_ratio'];?>
                                    <div class="input-group-append">
                                        <span class="input-group-text">字/次</span>
                                    </div>
                                </div>
								<small class="form-text text-muted">每多少字插入1次水印（例如400=每400字插入1次）</small>
							</div>
						</div>
						
						<!-- 固定字符间隔插入设置 -->
						<div class="form-group row">
							<label class="col-sm-2 form-control-label">固定间隔-插入间隔：</label>
							<div class="col-sm-10">
                                <div class="input-group" style="max-width: 300px;">
                                    <?php echo $input['fixed_interval'];?>
                                    <div class="input-group-append">
                                        <span class="input-group-text">字符</span>
                                    </div>
                                </div>
								<small class="form-text text-muted">每多少个字符插入1次水印（推荐20左右）</small>
							</div>
						</div>
						
						<!-- 调试模式 -->
						<div class="form-group row">
							<label class="col-sm-2 form-control-label">调试模式：</label>
							<div class="col-sm-10">
								<?php echo $input['debug_mode'];?>
								<small class="form-text text-muted">启用后水印将以可见文本展示（[水印调试：xxx]），生产环境请禁用</small>
							</div>
						</div>
					</div>

					<!-- 水印内容设置 -->
                    <div class="mb-5 pb-3 border-bottom">
                        <h4 class="mb-3"><i class="fa fa-file-text fa-fw"></i> 水印内容设置</h4>
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">包含访客IP：</label>
                            <div class="col-sm-10">
                                <?php echo $input['include_ip'];?>
                                <small class="form-text text-muted">嵌入访客IP地址，用于用户溯源定位</small>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">包含用户ID：</label>
                            <div class="col-sm-10">
                                <?php echo $input['include_user'];?>
                                <small class="form-text text-muted">登录用户显示ID，访客显示"guest"</small>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">包含作者ID：</label>
                            <div class="col-sm-10">
                                <?php echo $input['include_author'];?>
                                <small class="form-text text-muted">嵌入帖子作者ID，用于版权追溯</small>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">包含帖子ID：</label>
                            <div class="col-sm-10">
                                <?php echo $input['include_thread'];?>
                                <small class="form-text text-muted">嵌入帖子ID，用于内容定位</small>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">包含时间戳：</label>
                            <div class="col-sm-10">
                                <?php echo $input['include_time'];?>
                                <small class="form-text text-muted">水印生成时间（格式：YYYY-MM-DD HH:MM:SS）</small>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">包含自定义文本：</label>
                            <div class="col-sm-10">
                                <?php echo $input['include_custom'];?>
                                <small class="form-text text-muted">是否嵌入自定义版权等信息</small>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">自定义文本内容：</label>
                            <div class="col-sm-10">
                                <div style="max-width: 500px;">
                                    <?php echo $input['custom_text'];?>
                                </div>
                                <small class="form-text text-muted">建议包含站点版权信息（例如："XX站点 版权所有"）</small>
                            </div>
                        </div>
                    </div>

					<!-- 高级设置 -->
                    <div class="mb-5 pb-3 border-bottom">
                        <h4 class="mb-3"><i class="fa fa-sliders fa-fw"></i> 高级设置</h4>
                        <div class="form-group row">
                            <label class="col-sm-2 form-control-label">待处理HTML标签：</label>
                            <div class="col-sm-10">
                                <div style="max-width: 500px;">
                                    <?php echo $input['html_tags'];?>
                                </div>
                                <small class="form-text text-muted">
                                    用英文逗号分隔，仅处理帖子内容，非递归仅一级，默认：p,li<br>
                                    常用帖子标签：h2-h6、p、li、span、strong、em、b、i、blockquote、q等<br>
                                    不推荐：code、pre（代码标签）
                                </small>
                            </div>
                        </div>
                    </div>

					<!-- 爬虫过滤白名单 -->
					<div class="mb-5">
						<h4 class="mb-3"><i class="fa fa-spider fa-fw"></i> 爬虫过滤白名单</h4>
						<div class="form-group row">
							<label class="col-sm-2 form-control-label">爬虫UA列表：</label>
							<div class="col-sm-10">
                                <div style="max-width: 500px;">
                                    <?php echo $input['bot_ua'];?>
                                </div>
								<small class="form-text text-muted">每行一个爬虫标识，匹配到后不插入水印，留空则不匹配<br>用于防止搜索引擎抓取异常，建议配合WAF拦截伪造爬虫</small>
							</div>
						</div>
					</div>

					<!-- 提交按钮 -->
					<div class="form-group row" style="margin-top: 20px;">
						<label for="inputPassword3" class="col-sm-2 form-control-label"></label>
						<div class="col-sm-10">
							<button type="submit" class="btn btn-primary btn-block" id="submit" data-loading-text="提交中...">确认提交</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<?php include _include(ADMIN_PATH.'view/htm/footer.inc.htm');?>

<style>
/* 确保所有输入框都有足够的宽度 */
.form-control {
    min-width: 200px;
}

/* 为输入框组设置合适宽度 */
.input-group {
    width: auto;
    min-width: 200px;
}
</style>

<script>
var jform = $('#form');
var jsubmit = $('#submit');

// 页面初始化
$(function() {
    // 修正Tab高亮
    var currentPage = window.location.search;
    $('.btn-group').find('a').each(function() {
        var tabHref = $(this).attr('href') || '';
        if (currentPage.indexOf(tabHref) !== -1 || currentPage.indexOf(tabHref.replace('?', '')) !== -1) {
            $(this).addClass('active');
            $(this).siblings('a').removeClass('active');
            return false;
        }
    });

    // 备用：文本匹配
    var $wxstbwTab = $('.btn-group a:contains("文本盲水印设置")');
    if ($wxstbwTab.length > 0 && !$wxstbwTab.hasClass('active')) {
        $wxstbwTab.addClass('active');
        $wxstbwTab.siblings('a').removeClass('active');
    }

    // 激活设置菜单
    $('#nav li.nav-item-setting').addClass('active');
});

// 表单提交逻辑
jform.on('submit', function() {
    jsubmit.button('loading');
    var postdata = jform.serialize();
    $.xpost(jform.attr('action'), postdata, function(code, message) {
        if(code == 0) {
            $.alert(message);
            jsubmit.text(message).delay(1000).button('reset');
        } else if(code < 0) {
            $.alert(message);
            jsubmit.button('reset');
        } else {
            jform.find('[name="'+code+'"]').alert(message).focus();
            jsubmit.button('reset');
        }
    });
    return false;
});
</script>
