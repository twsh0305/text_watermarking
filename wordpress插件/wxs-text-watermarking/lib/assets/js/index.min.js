document.addEventListener('DOMContentLoaded',function(){const wxstbw_isUserLoggedIn=window.wxstbw_isUserLoggedIn||false;const wxstbw_current_user_id=window.wxstbw_current_user_id||false;const wxstbw_current_user_roles=window.wxstbw_current_user_roles||[];const wxstbw_isArticlePage=window.wxstbw_isArticlePage||false;const config=window.wxstbwConfig||{};const normalizedConfig={...config,enable:!!Number(config.enable),user_group_enable:!!Number(config.user_group_enable||0),user_group_type:config.user_group_type||'wordpress',wordpress_user_roles:Array.isArray(config.wordpress_user_roles)?config.wordpress_user_roles:[],jsGlobalEnable:!!Number(config.jsGlobalEnable),global_force_article:!!Number(config.global_force_article),debug_mode:!!Number(config.debug_mode),watermark_content:{include_ip:!!Number(config.watermark_content?.include_ip||0),include_user:!!Number(config.watermark_content?.include_user||0),include_time:!!Number(config.watermark_content?.include_time||0),include_custom:!!Number(config.watermark_content?.include_custom||0),custom_text:config.watermark_content?.custom_text||''},min_paragraph_length:parseInt(config.min_paragraph_length)||20,insert_method:parseInt(config.insert_method)||2,random:{count_type:parseInt(config.random?.count_type)||2,custom_count:parseInt(config.random?.custom_count)||1,word_based_ratio:parseInt(config.random?.word_based_ratio)||400},fixed:{interval:parseInt(config.fixed?.interval)||20}};const isDebug=normalizedConfig.debug_mode;if(isDebug){console.log('文本盲水印JS初始化');console.log('配置:',normalizedConfig);console.log('用户状态:',{isLoggedIn:wxstbw_isUserLoggedIn,userId:wxstbw_current_user_id,userRoles:wxstbw_current_user_roles,isArticlePage:wxstbw_isArticlePage})}if(!normalizedConfig.enable){if(isDebug)console.log('插件未启用，跳过处理');return}if(normalizedConfig.user_group_enable){const userRoles=Array.isArray(wxstbw_current_user_roles)?wxstbw_current_user_roles:[];const isGuest=!wxstbw_isUserLoggedIn;let shouldProcess=true;switch(normalizedConfig.user_group_type){case'wordpress':if(isGuest){shouldProcess=true;if(isDebug)console.log('用户组控制: 游客用户，默认处理水印')}else if(normalizedConfig.wordpress_user_roles.length>0){shouldProcess=false;for(const role of userRoles){if(normalizedConfig.wordpress_user_roles.includes(role)){shouldProcess=true;break}}if(isDebug){console.log(`用户组控制:WordPress角色检查-用户角色:${userRoles.join(', ')}`);console.log(`用户组控制:插入水印的角色:${normalizedConfig.wordpress_user_roles.join(', ')}`);console.log(`用户组控制:是否允许插入水印:${shouldProcess}`)}}else{shouldProcess=true;if(isDebug)console.log('用户组控制: 未配置允许的角色，默认处理所有用户')}break;case'custom':shouldProcess=true;if(isDebug){console.log('用户组控制: 自定义用户组模式 - 复杂权限检查在PHP端完成')}break}if(!shouldProcess){if(isDebug){console.log('用户组控制 - 跳过当前用户的水印处理');console.log('用户角色:',userRoles);console.log('允许的角色:',normalizedConfig.wordpress_user_roles)}return}}if(normalizedConfig.run_mode==='hybrid'&&wxstbw_isUserLoggedIn){if(isDebug)console.log('混合模式 - 登录用户，跳过JS处理');return}if(normalizedConfig.run_mode==='dynamic'){if(isDebug)console.log('动态模式 - 纯PHP处理，跳过JS');return}const userAgent=navigator.userAgent.toLowerCase();const botUAs=(Array.isArray(normalizedConfig.bot_ua)?normalizedConfig.bot_ua:[]).map(bot=>bot.toString().trim().toLowerCase()).filter(bot=>bot);const isBot=botUAs.some(bot=>userAgent.includes(bot));if(isBot){if(isDebug)console.log('检测到爬虫，跳过处理');return}function byteToChar(byte){if(!Number.isInteger(byte)||byte<0||byte>255)return'';if(byte<16){return String.fromCodePoint(0xFE00+byte)}else{return String.fromCodePoint(0xE0100+(byte-16))}}let pageIP='unknown';async function fetchIP(){try{const currentUrl=new URL(window.location.href);currentUrl.searchParams.set('wxstbw_query','getip');const response=await fetch(currentUrl.toString());const data=await response.json();if(data.success){pageIP=data.ip}}catch(error){if(isDebug)console.error('获取IP失败:',error)}}function generateWatermarkContent(){const parts=[];if(normalizedConfig.watermark_content.include_ip){parts.push(`IP:${pageIP}`)}if(normalizedConfig.watermark_content.include_user){parts.push(`USER:${wxstbw_isUserLoggedIn?wxstbw_current_user_id:'guest'}`)}if(normalizedConfig.watermark_content.include_time){const now=new Date();const timeStr=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;parts.push(`TIME:${timeStr}`)}if(normalizedConfig.watermark_content.include_custom&&normalizedConfig.watermark_content.custom_text){parts.push(normalizedConfig.watermark_content.custom_text)}return parts.join('|')}async function generateWatermark(){await fetchIP();const rawContent=generateWatermarkContent();if(isDebug){console.log('水印内容:',rawContent);return`[JS-WATERMARK:${rawContent}]`}const encoder=new TextEncoder();const bytes=encoder.encode(rawContent);let watermark='';for(let i=0;i<bytes.length;i++){watermark+=byteToChar(bytes[i])}return watermark}async function processTextNode(node,watermark){const originalText=node.textContent;if(originalText.length<normalizedConfig.min_paragraph_length){return originalText}let processedText=originalText;switch(normalizedConfig.insert_method){case 1:processedText=originalText+watermark;break;case 2:const textLength=originalText.length;let insertCount;if(normalizedConfig.random.count_type===1){insertCount=Math.max(1,normalizedConfig.random.custom_count)}else{insertCount=Math.max(1,Math.floor(textLength/normalizedConfig.random.word_based_ratio))}insertCount=Math.min(insertCount,Math.max(1,textLength-1));const positions=[];for(let i=0;i<insertCount;i++){let pos;do{pos=Math.floor(Math.random()*(textLength-1))+1}while(positions.includes(pos)&&positions.length<textLength);if(!positions.includes(pos)){positions.push(pos)}}positions.sort((a,b)=>a-b);let result='';let lastPos=0;for(const pos of positions){result+=originalText.substring(lastPos,pos);result+=watermark;lastPos=pos}result+=originalText.substring(lastPos);processedText=result;break;case 3:const interval=Math.max(5,normalizedConfig.fixed.interval);let fixedResult='';for(let i=0;i<originalText.length;i++){fixedResult+=originalText[i];if((i+1)%interval===0&&i<originalText.length-1){fixedResult+=watermark}}processedText=fixedResult;break}return processedText}async function processElement(element,watermark,tags){const tagName=element.tagName.toLowerCase();const shouldProcess=tags.includes(tagName);if(!shouldProcess&&!normalizedConfig.jsGlobalEnable){return}const walker=document.createTreeWalker(element,NodeFilter.SHOW_TEXT,{acceptNode:function(node){if(!node.textContent.trim()){return NodeFilter.FILTER_REJECT}return NodeFilter.FILTER_ACCEPT}});const textNodes=[];let node;while(node=walker.nextNode()){textNodes.push(node)}for(const textNode of textNodes){const processedText=await processTextNode(textNode,watermark);if(processedText!==textNode.textContent){textNode.textContent=processedText}}}async function initializeProcessing(){if(isDebug)console.log('开始处理水印');const watermark=await generateWatermark();if(!watermark||watermark.length===0){if(isDebug)console.log('水印为空，跳过处理');return}const tags=Array.isArray(normalizedConfig.htmlTags)?normalizedConfig.htmlTags:['p','li'];if(isDebug)console.log('处理的标签:',tags);if(wxstbw_isArticlePage){if(isDebug)console.log('处理文章页面内容');const articleSelectors=['.article-content','.post-content','.entry-content','#content .article','.post'];let articleContainer=null;for(const selector of articleSelectors){articleContainer=document.querySelector(selector);if(articleContainer)break}if(articleContainer){for(const tag of tags){const elements=articleContainer.querySelectorAll(tag);if(isDebug)console.log(`找到${elements.length}个<${tag}>元素`);for(const element of elements){await processElement(element,watermark,tags)}}}}if(normalizedConfig.jsGlobalEnable){if(isDebug)console.log('处理全局选择器');const selectors=[];if(normalizedConfig.jsClassSelectors){const classSelectors=normalizedConfig.jsClassSelectors.split(',').map(s=>s.trim()).filter(s=>s).map(s=>s.startsWith('.')?s:'.'+s);selectors.push(...classSelectors)}if(normalizedConfig.jsIdSelectors){const idSelectors=normalizedConfig.jsIdSelectors.split(',').map(s=>s.trim()).filter(s=>s).map(s=>s.startsWith('#')?s:'#'+s);selectors.push(...idSelectors)}if(selectors.length>0){for(const selector of selectors){try{const elements=document.querySelectorAll(selector);if(isDebug)console.log(`选择器${selector}找到${elements.length}个元素`);for(const element of elements){await processElement(element,watermark,tags)}}catch(error){if(isDebug)console.error(`选择器错误${selector}:`,error)}}}}if(isDebug)console.log('水印处理完成')}initializeProcessing().catch(error=>{if(isDebug)console.error('水印处理失败:',error)})});
