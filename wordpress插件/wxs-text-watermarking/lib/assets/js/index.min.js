document.addEventListener('DOMContentLoaded',function(){const wxstbw_isUserLoggedIn=window.wxstbw_isUserLoggedIn||false;const wxstbw_current_user_id=window.wxstbw_current_user_id||false;const wxstbw_current_user_roles=window.wxstbw_current_user_roles||[];const wxstbw_isArticlePage=window.wxstbw_isArticlePage||false;const config=window.wxstbwConfig||{};const normalizedConfig={...config,enable:!!Number(config.enable),user_group_enable:!!Number(config.user_group_enable||0),user_group_type:config.user_group_type||'wordpress',wordpress_user_roles:Array.isArray(config.wordpress_user_roles)?config.wordpress_user_roles:[],jsGlobalEnable:!!Number(config.jsGlobalEnable),global_force_article:!!Number(config.global_force_article),debug_mode:!!Number(config.debug_mode),watermark_content:{include_ip:!!Number(config.watermark_content?.include_ip||0),include_user:!!Number(config.watermark_content?.include_user||0),include_time:!!Number(config.watermark_content?.include_time||0),include_custom:!!Number(config.watermark_content?.include_custom||0),custom_text:config.watermark_content?.custom_text||''},min_paragraph_length:parseInt(config.min_paragraph_length)||20,insert_method:parseInt(config.insert_method)||2,random:{count_type:parseInt(config.random?.count_type)||2,custom_count:parseInt(config.random?.custom_count)||1,word_based_ratio:parseInt(config.random?.word_based_ratio)||400},fixed:{interval:parseInt(config.fixed?.interval)||20},htmlTags:Array.isArray(config.htmlTags)?config.htmlTags:['p','li'],bot_ua:Array.isArray(config.bot_ua)?config.bot_ua:[],run_mode:config.run_mode||'hybrid'};const isDebug=normalizedConfig.debug_mode;if(isDebug){console.log('文本盲水印JS初始化');console.log('配置:',normalizedConfig);console.log('用户状态:',{isLoggedIn:wxstbw_isUserLoggedIn,userId:wxstbw_current_user_id,userRoles:wxstbw_current_user_roles,isArticlePage:wxstbw_isArticlePage})}if(!normalizedConfig.enable){if(isDebug)console.log('插件未启用，跳过处理');return}if(normalizedConfig.user_group_enable){const userRoles=Array.isArray(wxstbw_current_user_roles)?wxstbw_current_user_roles:[];const isGuest=!wxstbw_isUserLoggedIn;let shouldProcess=true;switch(normalizedConfig.user_group_type){case'wordpress':if(isGuest){shouldProcess=true;if(isDebug)console.log('用户组控制: 游客用户，默认处理水印')}else if(normalizedConfig.wordpress_user_roles.length>0){shouldProcess=false;for(const role of userRoles){if(normalizedConfig.wordpress_user_roles.includes(role)){shouldProcess=true;break}}if(isDebug){console.log(`用户组控制:WordPress角色检查-用户角色:${userRoles.join(', ')}`);console.log(`用户组控制:插入水印的角色:${normalizedConfig.wordpress_user_roles.join(', ')}`);console.log(`用户组控制:是否允许插入水印:${shouldProcess}`)}}else{shouldProcess=true;if(isDebug)console.log('用户组控制: 未配置允许的角色，默认处理所有用户')}break;case'custom':shouldProcess=true;if(isDebug){console.log('用户组控制: 自定义用户组模式 - 复杂权限检查在PHP端完成')}break}if(!shouldProcess){if(isDebug){console.log('用户组控制 - 跳过当前用户的水印处理');console.log('用户角色:',userRoles);console.log('允许的角色:',normalizedConfig.wordpress_user_roles)}return}}if(normalizedConfig.run_mode==='hybrid'&&wxstbw_isUserLoggedIn){if(isDebug)console.log('混合模式 - 登录用户，跳过JS处理');return}if(normalizedConfig.run_mode==='dynamic'){if(isDebug)console.log('动态模式 - 纯PHP处理，跳过JS');return}const userAgent=navigator.userAgent.toLowerCase();const botUAs=normalizedConfig.bot_ua.map(bot=>bot.toString().trim().toLowerCase()).filter(bot=>bot);const isBot=botUAs.some(bot=>userAgent.includes(bot));if(isBot){if(isDebug)console.log('检测到爬虫，跳过处理');return}const VARIATION_SELECTOR_START=0xFE00;const VARIATION_SELECTOR_SUPPLEMENT_START=0xE0100;function byteToChar(byte){if(!Number.isInteger(byte)||byte<0||byte>255)return'';if(byte<16){return String.fromCodePoint(VARIATION_SELECTOR_START+byte)}else{return String.fromCodePoint(VARIATION_SELECTOR_SUPPLEMENT_START+(byte-16))}}let pageIP='unknown';async function fetchIP(){try{const currentUrl=window.location.href;const url=new URL(currentUrl);url.searchParams.set('wxstbw_query','getip');url.hash='';if(isDebug){console.log('请求IP的URL:',url.toString())}const response=await fetch(url.toString(),{method:'GET',headers:{'Accept':'application/json','X-Requested-With':'XMLHttpRequest'},credentials:'same-origin'});if(!response.ok){throw new Error(`HTTP error!status:${response.status}`)}const data=await response.json();if(data.success){pageIP=data.ip;if(isDebug){console.log('获取到IP地址:',pageIP)}}else{if(isDebug){console.warn('获取IP失败:',data.error||'未知错误')}}}catch(error){if(isDebug){console.error('获取IP失败:',error);pageIP='unknown'}}}function generateWatermarkContent(){const parts=[];if(normalizedConfig.watermark_content.include_ip){parts.push(`IP:${pageIP}`)}if(normalizedConfig.watermark_content.include_user){parts.push(`USER:${wxstbw_isUserLoggedIn?wxstbw_current_user_id:'guest'}`)}if(normalizedConfig.watermark_content.include_time){const now=new Date();const timeStr=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')+':'+String(now.getSeconds()).padStart(2,'0');parts.push(`TIME:${timeStr}`)}if(normalizedConfig.watermark_content.include_custom&&normalizedConfig.watermark_content.custom_text){parts.push(normalizedConfig.watermark_content.custom_text)}return parts.join('|')}async function generateWatermark(){if(normalizedConfig.watermark_content.include_ip){await fetchIP()}const rawContent=generateWatermarkContent();if(isDebug){console.log('水印内容:',rawContent);return`[JS-WATERMARK:${rawContent}]`}const encoder=new TextEncoder();const bytes=encoder.encode(rawContent);let watermark='';for(let i=0;i<bytes.length;i++){watermark+=byteToChar(bytes[i])}return watermark}function calcRandomCount(textLength){if(normalizedConfig.random.count_type==1){const customCount=normalizedConfig.random.custom_count||1;return Math.max(1,customCount)}else{const ratio=normalizedConfig.random.word_based_ratio||400;return Math.max(1,Math.floor(textLength/ratio))}}function isInsideExcludedTag(node){let parent=node.parentElement;while(parent){const tagName=parent.tagName.toLowerCase();if(tagName==='code'){return true}parent=parent.parentElement}return false}const URL_PATTERN=/(https?:\/\/[^\s"<>]+)/gi;function processTextWithUrlFilter(text,watermark){if(!text||!watermark){return text}const parts=text.split(URL_PATTERN);if(parts.length===1){return processParagraph(text,watermark)}let result='';for(let i=0;i<parts.length;i++){if(i%2===0){result+=processParagraph(parts[i],watermark)}else{result+=parts[i]}}return result}function processParagraph(text,watermark){const minLength=normalizedConfig.min_paragraph_length||20;const textLength=text.length;if(textLength<minLength||!watermark){return text}const method=normalizedConfig.insert_method||2;switch(method){case 1:return text+watermark;case 2:const insertCount=calcRandomCount(textLength);const positions=[];const actualInsertCount=Math.min(insertCount,textLength-1);for(let i=0;i<actualInsertCount;i++){let pos;do{pos=Math.floor(Math.random()*(textLength-1))+1}while(positions.includes(pos));positions.push(pos)}positions.sort((a,b)=>a-b);let result="";let lastPos=0;for(const pos of positions){result+=text.substring(lastPos,pos);result+=watermark;lastPos=pos}result+=text.substring(lastPos);return result;case 3:const interval=Math.max(5,normalizedConfig.fixed.interval||20);let fixedResult="";for(let i=0;i<textLength;i++){fixedResult+=text[i];if((i+1)%interval===0&&i<textLength-1){fixedResult+=watermark}}return fixedResult;default:return text}}function processTextNode(node,watermark){if(isInsideExcludedTag(node)){return}const originalText=node.nodeValue;const processedText=processTextWithUrlFilter(originalText,watermark);if(processedText!==originalText){node.nodeValue=processedText}}async function processElement(element,watermark){const walker=document.createTreeWalker(element,NodeFilter.SHOW_TEXT,{acceptNode:function(node){if(!node.nodeValue||!node.nodeValue.trim()){return NodeFilter.FILTER_REJECT}return NodeFilter.FILTER_ACCEPT}});let node;const nodesToProcess=[];while(node=walker.nextNode()){nodesToProcess.push(node)}for(const textNode of nodesToProcess){processTextNode(textNode,watermark)}}async function initializeProcessing(){if(isDebug)console.log('开始处理水印');const watermark=await generateWatermark();if(!watermark||watermark.length===0){if(isDebug)console.log('水印为空，跳过处理');return}if(isDebug)console.log('水印长度:',watermark.length);const tags=normalizedConfig.htmlTags;if(isDebug)console.log('处理的标签:',tags);if(wxstbw_isArticlePage||normalizedConfig.global_force_article){if(isDebug)console.log('处理文章页面内容');for(const tag of tags){const elements=document.querySelectorAll(tag);if(isDebug&&elements.length>0){console.log(`找到${elements.length}个<${tag}>元素`)}for(const element of elements){await processElement(element,watermark)}}}if(normalizedConfig.jsGlobalEnable){if(isDebug)console.log('处理全局选择器');const selectors=[];if(normalizedConfig.jsClassSelectors){const classSelectors=normalizedConfig.jsClassSelectors.split(',').map(s=>s.trim()).filter(s=>s).map(s=>s.startsWith('.')?s:'.'+s);selectors.push(...classSelectors)}if(normalizedConfig.jsIdSelectors){const idSelectors=normalizedConfig.jsIdSelectors.split(',').map(s=>s.trim()).filter(s=>s).map(s=>s.startsWith('#')?s:'#'+s);selectors.push(...idSelectors)}if(selectors.length>0){for(const selector of selectors){try{const elements=document.querySelectorAll(selector);if(isDebug&&elements.length>0){console.log(`选择器${selector}找到${elements.length}个元素`)}for(const element of elements){const tagName=element.tagName.toLowerCase();if(tags.includes(tagName)){await processElement(element,watermark)}}}catch(error){if(isDebug)console.error(`选择器错误${selector}:`,error)}}}}if(isDebug)console.log('水印处理完成')}initializeProcessing().catch(error=>{if(isDebug)console.error('水印处理失败:',error)})});
